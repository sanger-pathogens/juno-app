# codecov removed 2021-04-15 after security breach notice

stages:
  - build
  - push
  
  
variables:
  DOCKER_IMAGE:             "${CI_REGISTRY_IMAGE}/docker:19"
  DOCKER_DIND_IMAGE:        "${CI_REGISTRY_IMAGE}/gitlab-ci-dind:latest"

services:
  - name:  gitlab-registry.internal.sanger.ac.uk/sanger-pathogens/juno-app/gitlab-ci-dind:gitlab-registry.internal.sanger.ac.uk/sanger-pathogens/juno-app/gitlab-ci-dind:0e24a82512bd6f5721420a5833e0dc5ee621936e
    alias: docker

before_script:
  - echo -n ${CI_JOB_TOKEN} | docker login -u gitlab-ci-token --password-stdin ${CI_REGISTRY}

Build:
  stage: build
  tags:
    - openstack-autoscale-theta
  script:
    - docker info
    - echo "üê≥ Building ${IMAGE_NAME}:${CI_COMMIT_TAG} üê≥"
    - docker pull ${IMAGE_NAME}:latest || true
    - docker build --build-arg BUILDKIT_INLINE_CACHE=1 --cache-from ${IMAGE_NAME}:latest --tag ${IMAGE_NAME}:${CI_COMMIT_TAG} ./api/
    - echo "üê≥ Pushing ${IMAGE_NAME}:${CI_COMMIT_TAG} üê≥"
    - docker push ${IMAGE_NAME}:${CI_COMMIT_TAG}

# at every release/tag, tag the images built from the latest image builds as 'latest'
Push tag:
  variables:
    # only working with docker images; don't need to clone repo
    GIT_STRATEGY: none
  stage: push
  tags:
    - openstack-autoscale-theta
  only:
    - tags
  script:
    - docker pull ${IMAGE_NAME}:${CI_COMMIT_TAG}
    - >
         for this_tag in $CI_COMMIT_REF_NAME 'latest'; do
            docker tag  ${IMAGE_NAME}:${CI_COMMIT_TAG} ${IMAGE_NAME}:${this_tag}
            echo "üê≥ Pushing ${IMAGE_NAME}:${this_tag} üê≥"
            docker push ${IMAGE_NAME}:${this_tag}
         done